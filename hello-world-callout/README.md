# Hello world

This repo shows a sample of how to use the External Callout policy with Apigee X/hybrid.

## Components

### Hello world service

A hello-world sample external callout service is implemented [here](./cmd/server). You can install the service on Cloud Run (GCE and GKE also work perfectly fine). A Cloud Build install script is included [here](./cloudbuild.yaml). You can build & deploy with

```sh
gcloud builds submit --substitutions=_$PROJECT_ID="<PROJECT_NAME_HERE>"
```

### Setup Target Server

Configure a target server to call the External Service.

```sh
auth="Authorization: Bearer $(gcloud auth print-access-token)"

curl "https://apigee.googleapis.com/v1/organizations/$ORG/environments/$ENV/targetservers" -X POST -H $auth -H "Content-Type: application/json" --data-raw '{
  "name": "grpcserver",
  "host": "PUT_HOSTNAME_HERE",
  "port": 443,
  "isEnabled": true,
  "protocol": "GRPC",
  "sSLInfo": {
      "enabled": true,
      "ignoreValidationErrors": true
  }
}'
```

### API Proxy

Deploy the API Proxy included [here](./apiproxy).


### Extending? Here's how to perform Local Testing.

You may want to extend the golang code to do something more interesting.

To test the service locally, before you deploy it, follow these steps.  You will
need 3 terminal windows.

1. In window #1, run the GRPC service.
   ```
   go run cmd/server/main.go
   ```

   This is the thing you will eventually deploy to Cloud Run.

2. In window #2, run the GRPC "client".
   ```
   PORT=5950 go run cmd/client/main.go
   ```
   For testing purposes, this takes the place of the Apigee ExternalCallout policy.

3. In window #3, invoke that client (It's really a server).
   ```
   curl -i 0:5950/processmessage
   ```
   You should see a response that was generated by the GRPC service.


___

## Support

This is not an officially supported Google product
